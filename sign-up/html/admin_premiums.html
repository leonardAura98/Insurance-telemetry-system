<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Premiums - Admin Panel</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="top-nav">
        <div class="nav-brand">
            <h1>Admin Panel</h1>
        </div>
        <ul class="nav-links">
            <li><a href="admin_dashboard.html">Dashboard</a></li>
            <li><a href="admin_users.html">Users</a></li>
            <li><a href="admin_vehicles.html">Vehicles</a></li>
            <li><a href="admin_premiums.html" class="active">Premiums</a></li>
            <li><a href="management_signin.html">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <h2>Manage Premiums</h2>

        <!-- Search and Filter -->
        <div class="search-filter">
            <div class="filter-group">
                <input type="text" id="search-input" placeholder="Search by registration...">
                <select id="status-filter">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                </select>
                <button onclick="filterPremiums()">Filter</button>
            </div>
        </div>

        <!-- Premiums Table -->
        <table>
            <thead>
                <tr>
                    <th>Vehicle Registration</th>
                    <th>Owner</th>
                    <th>Premium Amount</th>
                    <th>Status</th>
                    <th>Due Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="premium-list">
                <!-- Premium data will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
        // Function to fetch premiums
        function fetchPremiums() {
            const premiumList = document.getElementById('premium-list');
            
            // Show loading state
            premiumList.innerHTML = '<tr><td colspan="6">Loading premiums...</td></tr>';
            
            fetch('../php/premium.php?action=fetch_premiums')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    let premiumTable = '';
                    if (data.length === 0) {
                        premiumTable = '<tr><td colspan="6">No premiums found</td></tr>';
                    } else {
                        data.forEach(premium => {
                            premiumTable += `
                                <tr>
                                    <td>${premium.reg_no}</td>
                                    <td>${premium.owner_name}</td>
                                    <td>Ksh ${premium.premium_amount}</td>
                                    <td>
                                        <span class="status-${premium.status.toLowerCase()}">
                                            ${premium.status}
                                        </span>
                                    </td>
                                    <td>${premium.due_date}</td>
                                    <td>
                                        <button onclick="editPremium(${premium.id})" class="btn-edit">Edit</button>
                                        <button onclick="deletePremium(${premium.id})" class="btn-delete">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    premiumList.innerHTML = premiumTable;
                })
                .catch(error => {
                    console.error('Error:', error);
                    premiumList.innerHTML = '<tr><td colspan="6">Error loading premiums</td></tr>';
                });
        }

        // Function to filter premiums
        function filterPremiums() {
            const searchTerm = document.getElementById('search-input').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            const premiumList = document.getElementById('premium-list');
            premiumList.innerHTML = '<tr><td colspan="6">Loading filtered results...</td></tr>';

            fetch(`../php/premium.php?action=fetch_premiums&search=${encodeURIComponent(searchTerm)}&status=${encodeURIComponent(statusFilter)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    let premiumTable = '';
                    if (data.length === 0) {
                        premiumTable = '<tr><td colspan="6">No matching premiums found</td></tr>';
                    } else {
                        // Same forEach loop as in fetchPremiums
                        data.forEach(premium => {
                            premiumTable += `
                                <tr>
                                    <td>${premium.reg_no}</td>
                                    <td>${premium.owner_name}</td>
                                    <td>Ksh ${premium.premium_amount}</td>
                                    <td>
                                        <span class="status-${premium.status.toLowerCase()}">
                                            ${premium.status}
                                        </span>
                                    </td>
                                    <td>${premium.due_date}</td>
                                    <td>
                                        <button onclick="editPremium(${premium.id})" class="btn-edit">Edit</button>
                                        <button onclick="deletePremium(${premium.id})" class="btn-delete">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    premiumList.innerHTML = premiumTable;
                })
                .catch(error => {
                    console.error('Error:', error);
                    premiumList.innerHTML = '<tr><td colspan="6">Error filtering premiums</td></tr>';
                });
        }

        // Function to delete premium
        function deletePremium(premiumId) {
            if (confirm('Are you sure you want to delete this premium record?')) {
                fetch('../php/premium.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=delete_premium&premium_id=${premiumId}`
                })
                .then(response => response.text())
                .then(result => {
                    showMessage('success', result);
                    fetchPremiums();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', 'Failed to delete premium');
                });
            }
        }

        // Load premiums when the page loads
        document.addEventListener('DOMContentLoaded', fetchPremiums);
    </script>
    <script src="../js/feedback.js"></script>
</body>
</html>
